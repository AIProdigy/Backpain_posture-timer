
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<title>Posture & Sitting Timer</title>
<link rel="stylesheet" href="style.css">

<!-- MediaPipe libs -->
<script src="https://unpkg.com/@mediapipe/camera_utils@0.3.1675466864/camera_utils.js"></script>
<script src="https://unpkg.com/@mediapipe/drawing_utils@0.3.1675466864/drawing_utils.js"></script>
<script src="https://unpkg.com/@mediapipe/pose@0.5.1675469404/pose.js"></script>
<style>
  /* small tweak so the controls are above the fold on iPhone */
  header { position: sticky; top: 0; background:#0f1115; z-index: 5; }
  #status { padding:8px 12px; margin:0 12px 10px; border-radius:10px; font-size:13px; }
  #status.ok{ background:#12362f; color:#d7fff1; border:1px solid #245c4d; }
  #status.err{ background:#2b1616; color:#ffd7d7; border:1px solid #5c1f1f; }
  .topButtons{ display:flex; gap:8px; padding:0 12px 10px; }
  .topButtons .btn{ flex:1; }
</style>
</head>
<body>
<header>
  <h1>Posture & Sitting Timer</h1>
  <label class="toggle">
    Sound
    <span class="switch"><input id="soundToggle" type="checkbox" checked><span class="slider"></span></span>
  </label>
</header>

<div id="status" class="ok">v0.2 — Ready. Tap <b>Start</b> to request camera.</div>
<div class="topButtons">
  <button id="startBtn" class="btn accent">Start</button>
  <button id="stopBtn" class="btn">Stop</button>
  <button id="resetBtn" class="btn warn">Reset</button>
</div>

<main>
  <div id="preview" class="card">
    <video id="video" playsinline style="display:none"></video>
    <canvas id="canvas"></canvas>
  </div>

  <div class="card">
    <div class="kpi">
      <div><div class="label">Base width</div><div id="kBase" class="value">--</div></div>
      <div><div class="label">Lumbar angle</div><div id="kLumbar" class="value">--</div></div>
      <div><div class="label">Shift</div><div id="kShift" class="value">--</div></div>
    </div>
    <div id="timer">00:00</div>
    <div id="suggestion" class="small"></div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px 0;">Adaptive Timer</h3>
    <div class="control-grid">
      <label class="small">Base interval (min)</label>
      <input id="baseInterval" type="range" min="10" max="40" step="5" value="20">
    </div>
    <div class="control-grid">
      <label class="small">Extend when good (min)</label>
      <input id="extendBy" type="range" min="0" max="15" step="5" value="10">
    </div>
    <div class="control-grid">
      <label class="small">Alert earlier when poor (min)</label>
      <input id="reduceBy" type="range" min="0" max="10" step="5" value="5">
    </div>
    <hr>
    <div class="control-grid">
      <label class="small">Target base width (cm, est.)</label>
      <input id="targetBase" type="range" min="0" max="30" step="1" value="8">
    </div>
    <div class="control-grid">
      <label class="small">Max lumbar flex (°)</label>
      <input id="maxFlex" type="range" min="5" max="40" step="1" value="20">
    </div>
    <div class="small" style="margin-top:8px">
      Tip: Place your iPhone ~1.5–2m in front of you at knee height. Sit side-on (45°) so the camera sees shoulders, hips, knees, and ankles.
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px 0;">Pain Check-in</h3>
    <div class="row">
      <input id="pain" type="range" min="0" max="10" step="1" value="1" style="flex:1">
      <button id="logPain" class="btn">Log</button>
    </div>
    <div class="small" id="lastLog">No logs yet.</div>
    <div class="small">Data is stored locally on your device.</div>
  </div>

  <div class="card small">
    <b>Micro-resets I’ll suggest:</b>
    <ul>
      <li><b>Narrow base realignment</b> — feet/knees closer, re-stack ribs over pelvis.</li>
      <li><b>Stand + brace</b> — McGill short-stop; hinge, brace, stand tall.</li>
      <li><b>Hook-lying breathing</b> — 2–3 minutes; neutral pelvis.</li>
    </ul>
  </div>
</main>
<footer>v0.2 prototype · On-device processing · For guidance only</footer>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const ui = {
    status: $('status'),
    video: $('video'),
    canvas: $('canvas'),
    kBase: $('kBase'),
    kLumbar: $('kLumbar'),
    kShift: $('kShift'),
    timer: $('timer'),
    suggestion: $('suggestion'),
    baseInterval: $('baseInterval'),
    extendBy: $('extendBy'),
    reduceBy: $('reduceBy'),
    targetBase: $('targetBase'),
    maxFlex: $('maxFlex'),
    soundToggle: $('soundToggle'),
    pain: $('pain'),
    logPain: $('logPain'),
    lastLog: $('lastLog'),
    startBtn: $('startBtn'),
    stopBtn: $('stopBtn'),
    resetBtn: $('resetBtn'),
  };

  // Quick visual logger
  const info  = (t)=>{ ui.status.className='ok'; ui.status.innerHTML=t; };
  const error = (t)=>{ ui.status.className='err'; ui.status.innerHTML='⚠️ ' + t; console.error(t); };

  // WebAudio beep (safe on iOS after user gesture)
  let ac;
  function beep() {
    if (!ui.soundToggle.checked) return;
    const Ctx = window.AudioContext || window.webkitAudioContext;
    if (!ac) ac = new Ctx();
    const o = ac.createOscillator(), g = ac.createGain();
    o.type='sine'; o.frequency.value=880;
    g.gain.value=0.001; o.connect(g).connect(ac.destination);
    o.start();
    g.gain.linearRampToValueAtTime(0.08, ac.currentTime+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+0.3);
    o.stop(ac.currentTime+0.35);
  }

  // Pain logs
  const store = {
    get(){ return JSON.parse(localStorage.getItem('pt_logs')||'[]'); },
    add(x){ const a=store.get(); a.push(x); localStorage.setItem('pt_logs', JSON.stringify(a)); }
  };
  function updateLastLog(){
    const a = store.get(); if (!a.length){ ui.lastLog.textContent='No logs yet.'; return; }
    const last = a[a.length-1];
    ui.lastLog.textContent = `Last log: pain ${last.pain}/10 at ${new Date(last.ts).toLocaleString()}`;
  }
  ui.logPain.addEventListener('click', ()=>{ store.add({pain:+ui.pain.value, ts:Date.now()}); updateLastLog(); });

  // Geometry helpers
  const ctx = ui.canvas.getContext('2d');
  const dist = (a,b)=> Math.hypot(a.x-b.x, a.y-b.y);
  function angle(a,b,c){
    const ab={x:a.x-b.x,y:a.y-b.y}, cb={x:c.x-b.x,y:c.y-b.y};
    const dot=ab.x*cb.x+ab.y*cb.y, mag=Math.hypot(ab.x,ab.y)*Math.hypot(cb.x,cb.y);
    if (!mag) return 0; let cos=dot/mag; cos=Math.min(1,Math.max(-1,cos)); return Math.acos(cos)*180/Math.PI;
  }
  function estimateBaseWidth(lm){
    const lA=lm[27], rA=lm[28], lK=lm[25], rK=lm[26];
    if(!lA||!rA||!lK||!rK) return null;
    const px=(dist(lA,rA)+dist(lK,rK))/2; const pxToCm=0.8; return px*pxToCm;
  }
  function lumbarAngle(lm){
    con
